<!-- 
     * @Page Name    : TestPage
     * @Description  : This page searches for accounts, leads around you or your searched location. Powered with responsive design and facebook type slider bar.
     * @Created By   : @SubodhBahl   
     * @Created On   : 
     * @Modification Log:  
     * --------------------------------------------------------------------------------------------------------------------------------
     * @Developer                Date                  Description              Comments
     * --------------------------------------------------------------------------------------------------------------------------------
     * @SubodhBahl                                      Created
     * --------------------------------------------------------------------------------------------------------------------------------
     * -->
    
    
    <apex:page standardController="Account" showHeader="false" sidebar="false" standardStylesheets="false" docType="html-5.0" language="en-US" applyHTMLTag="false" extensions="DTT_NearbyExt">
        <html lang="en">
            <head>
                <title>Camoplast Map Search</title>
                <!--<script src="https://code.jquery.com/jquery.js"></script>-->
                <!--**************************************  jQuery   ******************************************************-->
                 <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" />
                
                <!--************************************** BOOTSTRAP ******************************************************-->
                <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css" rel="stylesheet" media="screen"/>
                <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css"/>
                <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script> 
                
                <!--**************************************  MAXMIND API  ************************************************* -->
                <script src="//js.maxmind.com/js/apis/geoip2/v2.0/geoip2.js" type="text/javascript"></script>

                <!--************************************** GOOGLE MAPS API ************************************************-->
                <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
                   
                <!--*********************************************** CSS **************************************************-->
                <style>
                    
                    /******************************************** FRAMEWORK *********************************************/
                    html, body {
                       height: 100%;
                       font-family:verdana,arial,sans-serif;
                       color:#555555;
                    }
    
                    .nav {
                       font-family:Arial,sans-serif;
                       font-size:13px;
                    }
    
                    a {
                      color:#222222;
                    }
    
                    a:hover {
                      text-decoration:none;
                    }
    
                    hr {
                      border-color:#dedede;
                    }
    
                    .wrapper, .row {
                       height: 100%;
                       margin-left:0;
                       margin-right:0;
                    }
    
                    .wrapper:before, .wrapper:after,
                    .column:before, .column:after {
                        content: "";
                        display: table;
                    }
    
                    .wrapper:after,
                    .column:after {
                        clear: both;
                    }
    
                    .column {
                        height: 100%;
                        overflow: auto;
                        /**zoom:1;*/
                        *zoom: 5;
                    }
    
                    .column .padding {
                        padding: 20px;
                    }
    
                    .full{
                        padding-top:70px;
                    }
    
                    .box {
                        bottom: 0; /* increase for footer use */
                        left: 0;
                        position: absolute;
                        right: 0;
                        top: 0;
                        background-color:#444444;
                      /*
                        background-image:url('/assets/example/bg_suburb.jpg');
                        background-size:cover;
                        background-attachment:fixed;
                      */
                    }
    
                    .divider {
                        margin-top:32px;
                    }
    
                    .navbar-blue {
                        border-width:0;
                        background-color:#5cb85c;
                        color:#ffffff;
                        font-family:arial,sans-serif;
                        top:0;
                        position:fixed;
                        width:100%;
    
                    }
    
                    .navbar-blue li > a,.navbar-toggle  {
                       color:#efefef;
                    }
    
                    .navbar-blue .dropdown-menu li a {color:#5cb85c;}
                    .navbar-blue .dropdown-menu li > a {padding-left:30px;}
    
                    .navbar-blue li>a:hover, .navbar-blue li>a:focus, .navbar-blue .open, .navbar-blue .open>a, .navbar-blue .open>a:hover, .navbar-blue .open>a:focus {
                       background-color:#5cb85c;
                       color:#fff;
                    }
    
                    #main {
                       background-color:#e9eaed;
                       padding-left:0;
                       padding-right:0;
                    }
                    #main .img-circle {
                       margin-top:18px;
                       height:70px;
                       width:70px;
                    }
    
                    #sidebar {
                        padding:0px;
                        padding-top:15px;
                    }
    
                    #sidebar, #sidebar a, #sidebar-footer a {
                        color:#ffffff;
                        background-color:transparent;
                        text-shadow:0 0 2px #000000;
                        padding-left:5px;
                        padding-right:5px;
                    }
                    #sidebar .nav li>a:hover {
                        background-color:#393939;
                    }
    
                    .logo {
                      display:block;
                      padding:3px;
                      background-color:#5cb85c;
                      color:#fff;
                      height:28px;
                      width:120px;
                      margin:9px;
                      margin-right:15px;
                      margin-left:15px;
                      font-size:20px;
                      font-weight:300;
                      text-align:center;
                      text-decoration:none;
                      text-shadow:0 0 1px;
                      border-radius:2px;
                    }
                    #sidebar-footer {
                      background-color:#444;
                      position:absolute;
                      bottom:5px;
                      padding:5px;
                    }
                    #footer {
                      margin-bottom:20px;
                    }
    
                    /* bootstrap overrides */
    
                    h1,h2,h3 {
                       font-weight:800;
                    }
    
                    .navbar-toggle, .close {
                        outline:0;
                    }
    
                    .navbar-toggle .icon-bar {
                        background-color: #fff;
                    }
    
                    .btn-primary,.label-primary,.list-group-item.active, .list-group-item.active:hover, .list-group-item.active:focus  {
                        background-color:#5cb85c;
                        color:#fffffe;
                    }
                    .btn-default {
                        color:#666666;
                        text-shadow:0 0 1px rgba(0,0,0,.3);
                    }
                    .form-control {
                       
                    }
    
                    .panel textarea, .well textarea, textarea.form-control
                    {
                       resize: none;
                    }
                      
                    .badge{
                       color:#5cb85c;
                       background-color:#fff;
                    }
                    .badge:hover, .badge-inverse{
                       background-color:#5cb85c;
                       color:#fff;
                    }
                        
                    .jumbotron {
                      background-color:transparent;
                    }
                    .label-default {
                      background-color:#dddddd;
                    }
                    .page-header {
                      margin-top: 55px;
                      padding-top: 9px;
                      border-top:1px solid #eeeeee;
                      font-weight:700;
                      text-transform:uppercase;
                      letter-spacing:2px;
                    }
    
                    .panel-default .panel-heading {
                      background-color:#f9fafb;
                      color:#555555;
                    }
    
                    .col-sm-9.full {
                        width: 100%;
                    }
    
                    .modal-header, .modal-footer {
                        background-color:#f2f2f2;
                        font-weight:800;
                        font-size:12px;
                    }
    
                    .modal-footer i, .well i {
                        font-size:20px;
                        color:#c0c0c0;
                    }
    
                    .modal-body {
                        padding:0px;
                    }
    
                    .modal-body textarea.form-control
                    {
                       resize: none;
                       border:0;
                       box-shadow:0 0 0;
                    }
    
                    small.text-muted {
                      font-family:courier,courier-new,monospace;
                    }
    
                    /* adjust the contents on smaller devices */
                    @media (max-width: 768px) {
    
                      .column .padding {
                        padding: 7px;
                      }
    
                      .full{
                        padding-top:20px;
                      }
    
                      .navbar-blue {
                        background-color:#5cb85c;
                        top:0;
                        width:100%;
                        position:relative;
                      }
    
                    }
    
    
                    /**************************************** OFF CANVAS SIDEBAR ************************************************/
                     
                    @media screen and (max-width: 768px) {
                      .row-offcanvas {
                        position: relative;
                        -webkit-transition: all 0.25s ease-out;
                        -moz-transition: all 0.25s ease-out;
                        transition: all 0.25s ease-out;
                      }
    
                      .row-offcanvas-left.active {
                        left: 33%;
                      }
    
                      .row-offcanvas-left.active .sidebar-offcanvas {
                        left: -33%;
                        position: absolute;
                        top: 0;
                        width: 33%;
                        margin-left: 5px;
                      }
    
                      #sidebar, #sidebar a, #sidebar-footer a {
                        padding-left:3px;
                        padding-right:3px;
                      }
                    }
                    
                    .pushDown{
                      padding-top: 8px;
                    }                  
    
                    .legend{
                      border-color: blue;
                      border-width: 2px;
                      height: 50px;
                      width: 30px;
                      padding-left: 5px;
    
                    }
                    /******************************************* MAP CSS ***************************************************/
                    /*html, body { height: 100%; }*/
                    .page-map, .ui-content, #map-canvas {
                      position:absolute;
                      height:auto;
                      bottom:0;
                      top:0;
                      left:0;
                      right:0;
                      margin-top:30px;
                    }
                    #map-canvas { 
                      height: min-height: 100%; 
                      padding: 0;
                      margin:0;
                    }
                    
                    #legend {
                      background: white;
                      padding: 10px;
                      border-color: #4a8cf7;
                      border-width: 1px;
                      border-style: solid;
                    }


                    /*********************************  Responsive Custom Popup ******************************************/
                    
                    .customPopup{
                      background-color: white;
                      border-style: solid;
                      border-width: 2px;
                      padding:10px;
                      position: fixed;
                      z-index: 9999;
                      /* These are the 3 css properties you will need to tweak so the pop 
                      up displays in the center of the screen. First set the width. Then set 
                      margin-left to negative half of what the width is. You can also add 
                      the height property for a fixed size pop up.*/
                      width: 200px;
                      top:30%;
                      left:30%;
                      margin:0 auto;
                      /*position: fixed;
                      top: 50%;
                      left: 50%;*/
                    }

                    .responsive-iframe-container {
                        position: relative;
                        padding-bottom: 56.25%;
                        padding-top: 30px;
                        height: 0;
                        overflow: hidden;
                    }
                     
                    .responsive-iframe-container iframe,   
                    .vresponsive-iframe-container object,  
                    .vresponsive-iframe-container embed {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                    }
                </style>
    
                <script type="text/javascript">
                  $(document).ready(function() { 
                        $('[data-toggle=offcanvas]').click(function() {
                            $(this).toggleClass('visible-xs text-center');
                            $(this).find('i').toggleClass('glyphicon-chevron-right glyphicon-chevron-left');
                            $('.row-offcanvas').toggleClass('active');
                            $('#lg-menu').toggleClass('hidden-xs').toggleClass('visible-xs');
                            $('#xs-menu').toggleClass('visible-xs').toggleClass('hidden-xs');
                            $('#btnShow').toggle();
                        });
    
                  
              /*********************************** URL SETUP START *************************************************/
                       
                        // CONTAINS LOCATION INFO IN THE URL
                        if(window.location.href.indexOf("?location=") > -1) {                           
                            var url = document.location.toString();
                            var address = url.split('?location=')[1];

                            // CONTAINS A COMPLEX LOCATION INFO
                            if(address.indexOf("%20") > -1){                              
                               var addressClean = decodeURI(address);
                              
                              // URL HAS '&' 
                              if(address.indexOf("&") > -1){
                                 var addressWithoutAmp = returnAddress(addressClean);
                                 document.getElementById('address').value = addressWithoutAmp;

                                // SET THE CHECKBOXES
                                var param1 = addressClean.split('&')[1];
                                var param2 = addressClean.split('&')[2];

                                if(!param1 == ''){
                                  if(param1.indexOf('Accounts') > -1)
                                    document.getElementById('Accounts').checked = returnCheckboxAccounts(param1);
                               
                                  if(param1.indexOf('Leads') > -1)
                                    document.getElementById('Leads').checked = returnCheckboxLeads(param1);
                                }

                                if(!param2 == ''){
                                  if(param2.indexOf('Leads') > -1)
                                    document.getElementById('Leads').checked = returnCheckboxLeads(param2);
                               
                                  if(param2.indexOf('Accounts') > -1)
                                    document.getElementById('Accounts').checked = returnCheckboxAccounts(param2);
                                }

                                  // CALL APPLY METHOD
                               if(document.getElementById('Accounts').checked == true && document.getElementById('Leads').checked == true)
                                  google.maps.event.addDomListener(window, 'load', geocodeAddress(true,true));

                               if(document.getElementById('Accounts').checked == true && document.getElementById('Leads').checked == false)
                                  google.maps.event.addDomListener(window, 'load', geocodeAddress(true,false));

                               if(document.getElementById('Accounts').checked == false && document.getElementById('Leads').checked == true)
                                  google.maps.event.addDomListener(window, 'load', geocodeAddress(false,true));

                               if(document.getElementById('Accounts').checked == false && document.getElementById('Leads').checked == false)
                                  google.maps.event.addDomListener(window, 'load', geocodeAddress(false,false));
                              }

                              // URL HAS NO '&' - NO CHECKBOXES
                              else{ 
                                 document.getElementById('address').value = returnAddress(addressClean);
                                 google.maps.event.addDomListener(window, 'load', geocodeAddress(true,true));
                              }                              
                            }

                            // SIMPLE LOCATION WITH NO '%20'
                            else{ 
                               document.getElementById('address').value = returnAddress(address);

                               // SET THE CHECKBOXES
                               var param1 = address.split('&')[1];
                               var param2 = address.split('&')[2];

                              if(!param1 == ''){
                                if(param1.indexOf('Accounts') > -1)
                                  document.getElementById('Accounts').checked = returnCheckboxAccounts(param1);
                               
                                if(param1.indexOf('Leads') > -1)
                                  document.getElementById('Leads').checked = returnCheckboxLeads(param1);
                              }

                              if(!param2 == ''){
                                if(param2.indexOf('Leads') > -1)
                                  document.getElementById('Leads').checked = returnCheckboxLeads(param2);
                               
                                if(param2.indexOf('Accounts') > -1)
                                  document.getElementById('Accounts').checked = returnCheckboxAccounts(param2);
                              }
                              
                               // CALL APPLY METHOD
                               if(document.getElementById('Accounts').checked == true && document.getElementById('Leads').checked == true)
                                  google.maps.event.addDomListener(window, 'load', geocodeAddress(true,true));

                               if(document.getElementById('Accounts').checked == true && document.getElementById('Leads').checked == false)
                                  google.maps.event.addDomListener(window, 'load', geocodeAddress(true,false));

                               if(document.getElementById('Accounts').checked == false && document.getElementById('Leads').checked == true)
                                  google.maps.event.addDomListener(window, 'load', geocodeAddress(false,true));

                               if(document.getElementById('Accounts').checked == false && document.getElementById('Leads').checked == false)
                                  google.maps.event.addDomListener(window, 'load', geocodeAddress(false,false));
                               
                            }                 
                        }

                        // THIS DOES NOT CONTAIN ANY LOCATION INFO IN URL
                        else{
                            google.maps.event.addDomListener(window, 'load', initialize);
                        }

                          /* @Developer: @Subodh Bahl / Deloitte Consulting
                           * @Description: This function checks if there is an & in the URL and divides the location
                           * from the other params
                           */  
                          function returnAddress(address){
                            if(address.indexOf("&") > -1){
                              var addressOnly = address.split('&')[0];
                              return addressOnly;
                            }
                            else{
                              return address;
                            }
                          }


                          /* @Developer: @Subodh Bahl / Deloitte Consulting
                           * @Description: 
                           */
                           function returnCheckboxAccounts(param1){
                              if(param1.indexOf('Accounts=true') > -1)
                                  return true;
                             
                              if(param1.indexOf('Leads=true') > -1){
                                returnCheckboxLeads('Leads=true');
                              }
                            
                              else
                                  return false;
                            
                           }

                           /* @Developer: @Subodh Bahl / Deloitte Consulting
                            * @Description: 
                            */
                            function returnCheckboxLeads(param2){
                              if(param2.indexOf('Leads=true') > -1)
                                return true;
                             
                              if(param2.indexOf('Accounts=true'))
                                  returnCheckboxAccounts('Accounts=true');
                              
                              else
                                return false;
                              
                            }  

                  });
                  
              /******************************************** URL SETUP END *************************************************/
    
                  // VARIABLES
                  var geocoder; 
                  var map;
                  
                  var onSuccess = function(refLocation){
                    console.log("Lookup successful:\n\n" + JSON.stringify(refLocation, undefined, 4));
                    var locationJSON = JSON.parse(JSON.stringify(refLocation, undefined, 4));
                    alert(locationJSON);
                    
                    var maxMindLat = null;
                    var maxMindLong = null;
                    maxMindLong = locationJSON.location.longitude;
                    maxMindLat = locationJSON.location.latitude;
                    console.log("long1" +  maxMindLong);
                    console.log("lat1" +  maxMindLat);
    
                    InitMap(maxMindLat, maxMindLong);
                  };
    
                  var onError = function(error){
                    console.log("Error:\n\n" + JSON.stringify(error, undefined, 4));
                  };
    
    
    
    
                  function initialize() {
                    var lat, lon;
                    geocoder = new google.maps.Geocoder();
         
                    // If we can, get the position of the user via device geolocation
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position){
                          lat = position.coords.latitude;
                          lon = position.coords.longitude;                    
                          //InitMap(lat, lon);
                          var latlng = new google.maps.LatLng(lat, lon);
                          var currentPosition = new google.maps.LatLng(lat,lon);
                          var mapOptions = {
                                            zoom: 8, 
                                            center: latlng, 
                                            mapTypeControl: true,
                                            mapTypeControlOptions: {
                                                                    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                                                                    position: google.maps.ControlPosition.RIGHT_CENTER
                                                                   },
                                            panControl: true,
                                            panControlOptions: {
                                                                position: google.maps.ControlPosition.RIGHT_CENTER
                                                               },
                                            zoomControl: true,
                                            zoomControlOptions: {
                                                                style: google.maps.ZoomControlStyle.SMALL,
                                                                position: google.maps.ControlPosition.RIGHT_CENTER
                                                                },
                                            scaleControl: true,
                                            streetViewControl: true,
                                            streetViewControlOptions: {
                                                                position: google.maps.ControlPosition.RIGHT_CENTER
                                            }
                          }
                          map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);   
                          var marker = new google.maps.Marker({
                                                        map: map,
                                                        position: currentPosition,
                                                        icon: 'http://capturethefl.ag/app_demo/gfx/map-current-location-marker.png',
                                                        animation: google.maps.Animation.DROP
                            });
                          //marker.title('Your Location');
                          InitMap(lat, lon);
                        });
                    } 
                    else {
                      // Pierre Dufour - If HTML5 is not working, try with MindMax API.
                      geoip2.city(onSuccess, onError);
                    }
                  }
    

                  /*
                   * @Developer: @SubodhBahl/Deloitte Consulting
                   * @Description: This method applies filters and searches as per the filters
                   */                       
                  function applyFilters(){
                    var addressInfo = document.getElementById('address').value;
                    if(!addressInfo == ''){
                      
                      if(document.getElementById('Accounts').checked && document.getElementById('Leads').checked)
                        window.location.href = '/apex/TestPage?location='+addressInfo+'&Accounts=true&Leads=true';
                      
                      if(document.getElementById('Accounts').checked && document.getElementById('Leads').checked == false)
                        window.location.href = '/apex/TestPage?location='+addressInfo+'&Accounts=true&Leads=false'; 

                      if(document.getElementById('Accounts').checked == false && document.getElementById('Leads').checked)
                        window.location.href = '/apex/TestPage?location='+addressInfo+'&Accounts=false&Leads=true'; 

                      if(document.getElementById('Accounts').checked == false && document.getElementById('Leads').checked == false)
                        window.location.href = '/apex/TestPage?location='+addressInfo;
                    }
                    else
                      alert('Please search a location!');
                  }  



                  /*
                   * @Developer: @SubodhBahl/Deloitte Consulting
                   * @Description: This method geocodes the location in the search bar and checks if the user is searching for their own location
                   */                       
                  function geocodeAddress(Accounts, Leads){
                      //alert('reached here');
                    var address = document.getElementById('address').value;
                    //window.location.href = "/apex/TestPage?location="+address;
                    if(address == "My Location" || address == "my location" || address == "My location" || address == "my Location"){
                      initialize();
                    }
                    else{
                      geocoder = new google.maps.Geocoder();
                      //var map = ;
                      // Geocode the address, and drop the markers
                      geocoder.geocode( { 'address': address}, function(results, status) {
                      if(status == google.maps.GeocoderStatus.OK) {
                        var searchLat = results[0].geometry.location.lat();
                        var searchLong = results[0].geometry.location.lng();
    
                        var latlng = new google.maps.LatLng(searchLat, searchLong);
                        //var currentPosition = new google.maps.LatLng(lat,lon);
                        var mapOptions = {
                                            zoom: 8, 
                                            center: latlng, 
                                            mapTypeControl: true,
                                            mapTypeControlOptions: {
                                                                    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                                                                    position: google.maps.ControlPosition.RIGHT_CENTER
                                                                   },
                                            panControl: true,
                                            panControlOptions: {
                                                                position: google.maps.ControlPosition.RIGHT_CENTER
                                                               },
                                            zoomControl: true,
                                            zoomControlOptions: {
                                                                style: google.maps.ZoomControlStyle.SMALL,
                                                                position: google.maps.ControlPosition.RIGHT_CENTER
                                                                },
                                            scaleControl: true,
                                            streetViewControl: true,
                                            streetViewControlOptions: {
                                                                position: google.maps.ControlPosition.RIGHT_CENTER
                                          }
                        }
                      
                        if(searchLat != "" || searchLong != ""){
                            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);   
                            map.setCenter(results[0].geometry.location);
                            var marker = new google.maps.Marker({
                                                        map: map,
                                                        position: results[0].geometry.location,
                                                        icon: 'http://google.com/mapfiles/arrow.png',
                                                        animation: google.maps.Animation.DROP
                            });
                       
                         // true,true MEANS BOTH ARE CHECKED
                         // true, false MEANS Accounts is true and Leads is false
                         // false, true MEANS Leads is true and Accounts is false

                         // Init map
                         if(Accounts == true && Leads == true)
                            InitMap(searchLat, searchLong);

                         if(Accounts == true && Leads == false)
                            InitMapAccounts(searchLat, searchLong);
                         
                         if(Accounts == false && Leads == true)
                            InitMapLeads(searchLat, searchLong);          
                        }
                        else
                          alert('The address you searched could not be geocoded. Please try again!');
                      }                 
                      else {
                        /*
                         * @SubodhBahl/Deloitte Consulting 
                         * Check this link for the status codes:
                         * https://developers.google.com/maps/documentation/geocoding/
                         */
                        alert('Geocode was not successful for the following reason: ' + status);
                      }  
                    });
                   }
                  }
      

                  function InitMap(lat, lon){
                    // Use Visualforce JavaScript Remoting to query for nearby warehouses      
                     Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.DTT_NearbyExt.getNearby}', lat, lon,
                      function(result, event){
                        if (event.status) {
                          console.log(result);
                          createMap(lat, lon, result);  
                          PopulateLegend(map);          
                        } 
                        else if (event.type === 'exception') {
                          //exception case code          
                          alert(event.message);  
                        } 
                        else {
                          alert(event.message);  
                        }
                      }, 
                      {escape: true});
                  }


                  function InitMapAccounts(lat, lon){
                    // Use Visualforce JavaScript Remoting to query for nearby warehouses      
                     Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.DTT_NearbyExt.getNearbyAccounts}', lat, lon,
                      function(result, event){
                        if (event.status) {
                          console.log(result);
                          createMap(lat, lon, result);  
                          PopulateLegend(map);          
                        } 
                        else if (event.type === 'exception') {
                          //exception case code          
                          alert(event.message);  
                        } 
                        else {
                          alert(event.message);  
                        }
                      }, 
                      {escape: true});
                  }


                  function InitMapLeads(lat, lon){
                    // Use Visualforce JavaScript Remoting to query for nearby warehouses      
                     Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.DTT_NearbyExt.getNearbyLeads}', lat, lon,
                      function(result, event){
                        if (event.status) {
                          console.log(result);
                          createMap(lat, lon, result);  
                          PopulateLegend(map);          
                        } 
                        else if (event.type === 'exception') {
                          //exception case code          
                          alert(event.message);  
                        } 
                        else {
                          alert(event.message);  
                        }
                      }, 
                      {escape: true});
                  }

            
                  function createMap(lat, lon, warehouses){
                    // Get the map div, and center the map at the proper geolocation
                    var currentPosition = new google.maps.LatLng(lat,lon);
                    
                    // Keep track of the map boundary that holds all markers
                    var mapBoundary = new google.maps.LatLngBounds();
                    mapBoundary.extend(currentPosition);
                    
                    // Set markers on the map from the @RemoteAction results
                    var warehouse;
                    for(var i=0; i<warehouses.length;i++){
                      warehouse = warehouses[i];
                      console.log(warehouses[i]);
                      setupMarker(map, mapBoundary, warehouses[i]);
                    }
                    
                    // Resize map to neatly fit all of the markers
                    map.fitBounds(mapBoundary);
                  
                  }
                      
    
                  function PopulateLegend(map){
                    var maps = document.getElementById('map-canvas');
                    var legend = document.createElement('div');
                    legend.innerHTML = '<div id="legend" class="collapse navbar-collapse"><b>Legend</b> <br/> <img src="http://google.com/mapfiles/arrow.png">Location Searched</>  <br/> <img src="https://maps.google.com/mapfiles/ms/micons/blue-dot.png">Lead</> <br/> <img src="https://maps.google.com/mapfiles/ms/micons/yellow-dot.png">Customer - Inactive</> <br/> <img src="https://maps.google.com/mapfiles/ms/micons/red-dot.png">Customer - Active</> <br/> <img src="https://www.google.com/mapfiles/kml/paddle/wht-circle-lv.png" height="20" width="20">Non-Client Accounts</> </div>';
                    maps.appendChild(legend);

                    map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(document.getElementById('legend'));
                  }
    
    
                  function setupMarker(map, mapBoundary, warehouse){ 
                    var warehouseNavUrl;
                      
                    // Determine if we are in Salesforce1 and set navigation link appropriately
                    try{
                      if(sforce.one){
                        warehouseNavUrl = 'javascript:sforce.one.navigateToSObject(\'' + warehouse.Id + '\')';
                      }
                    } 
                    catch(err) {
                      console.log(err);
                      warehouseNavUrl = '\\' + warehouse.Id;
                    }
                      
                    var warehouseDetails = 'test';
                    console.log(warehouse.Id);
                    console.log(warehouse.Id.substring(0,2));
                      
                    if (warehouse.Id.substring(0,3) == '00Q'){
                      console.log('Should work');
                      warehouseDetails = '<a href="' + warehouseNavUrl + '">' + 
                      warehouse.Company + '</a><br/>O' + 
                      warehouse.Name + '</a><br/>' + 
                      warehouse.Street + '<br/>' + 
                      warehouse.City + '<br/>' + 
                      warehouse.Phone;
                    }
                    else{
                      if(!warehouse.Ship_To__c){
                        warehouseDetails = '<a href="' + warehouseNavUrl + '">' + 
                        warehouse.Name + '</a><br/>' + 
                        warehouse.BillingStreet + '<br/>' + 
                        warehouse.BillingCity + '<br/>' + 
                        warehouse.Phone;
                      }
    
                      if(warehouse.Ship_To__c){
                        warehouseDetails = '<a href="' + warehouseNavUrl + '">' + 
                        warehouse.Name + '</a><br/>' + 
                        warehouse.ShippingStreet + '<br/>' + 
                        warehouse.ShippingCity + '<br/>' + 
                        warehouse.Phone;
                      }                   
                    }
                        
                    // Create the callout that will pop up on the marker     
                    var infowindow = new google.maps.InfoWindow({ 
                      content: warehouseDetails
                    });
                       
                    // Place the marker on the map
                    var marker = null;
    
                    // 00Q = Leads
                    if (warehouse.Id.substring(0,3) == '00Q'){
                      marker = new google.maps.Marker({
                        map: map,
                        icon: 'https://maps.google.com/mapfiles/ms/micons/blue-dot.png', 
                        position: new google.maps.LatLng( 
                          warehouse.Location__Latitude__s, 
                          warehouse.Location__Longitude__s),
                        animation: google.maps.Animation.DROP
                      });
                    }
                    else{
                      if (warehouse.RecordType.Name == 'Client'){
                            marker = new google.maps.Marker({
                              map: map,
                              icon: warehouse.Total_Sales_Last_12_Months__c == 0 ? 'https://maps.google.com/mapfiles/ms/micons/yellow-dot.png' : 'https://maps.google.com/mapfiles/ms/micons/red-dot.png', 
                              position: new google.maps.LatLng( 
                                                      warehouse.Location__Latitude__s, 
                                                      warehouse.Location__Longitude__s),
                              animation: google.maps.Animation.DROP
                            });
                      }
    
                      if (warehouse.RecordType.Name == 'Non-Client'){
                            marker = new google.maps.Marker({
                              map: map,
                              icon: 'https://www.google.com/mapfiles/kml/paddle/wht-circle-lv.png', 
                              position: new google.maps.LatLng( 
                                                       warehouse.Location__Latitude__s, 
                                                       warehouse.Location__Longitude__s),
                              animation: google.maps.Animation.DROP
                            });
                      }
                    }
                        
                    mapBoundary.extend(marker.getPosition());
                       
                    // Add the action to open up the panel when it's marker is clicked      
                    google.maps.event.addListener(marker, 'click', function(){
                      infowindow.open(map, marker);
                    });
                  }
              </script>        
            </head>
    
    <!--*****************************************************    BODY   ************************************************************-->
            <body>
              <apex:form >
                <div class="wrapper">
                    <div class="box">
                        <div class="row row-offcanvas row-offcanvas-left">
                            
                <!--****************************************  SIDEBAR START   *************************************-->
                            <div class="column col-sm-2 col-xs-1 sidebar-offcanvas" id="sidebar">
                                <ul class="nav">
                                    <li>
                                      <a href="#" data-toggle="offcanvas" class="visible-xs text-center">
                                        <i class="glyphicon glyphicon-chevron-right"></i>
                                      </a>
                                    </li>
                                </ul>
                       <!--******************************* BIG SIDE NAV DESKTOP *****************************-->
                                <ul class="nav hidden-xs" id="lg-menu">
                                    <li class ="active, pushDown"> 
                                      <div class="checkbox">
                                        <label>
                                          <input type="checkbox" id="Accounts"> Accounts
                                          <img src="https://cdn1.iconfinder.com/data/icons/metro-uinvert-dock/128/User_Accounts.png" height="20" width="20"></img>
                                          </input>
                                        </label>
                                      </div>
                                    </li>
                                    <li>
                                      <div class="checkbox">
                                        <label>
                                          <input type="checkbox" id="Leads"> Leads
                                          <img src="https://cdn1.iconfinder.com/data/icons/metro-uinvert-dock/128/User_Accounts_alt.png" height="20" width="20"></img></input>
                                        </label>
                                      </div>
                                    </li>
                                    <!-- FILTERS 
                                    <li>
                                        <a href="#">
                                          <i class="glyphicon glyphicon-paperclip"></i> 
                                        Filter 1</a>
                                    </li>
                                    <li>
                                        <a href="#">
                                          <i class="glyphicon glyphicon-refresh"></i> 
                                        Filter 2</a>
                                    </li>-->
                                    <br/><br/><br/>
    
                                    <!--************************ BUTTONS ***************************-->
                                  <div style="text-align:center;padding-right:5px">  
                                      <li>
                                        <button class="btn btn-success btn-block" style="padding-bottom:1px; padding-top:1px" onClick="applyFilters(); return false;">
                                          <i class="glyphicon glyphicon-filter"></i> Apply
                                        </button>
                                        <button class="btn btn-info btn-block" style="padding-bottom:1px; padding-top:1px" onClick="openSaveModel()">
                                          <i class="glyphicon glyphicon-floppy-disk"></i> Save
                                        </button>
                                        <button class="btn btn-danger btn-block" style="padding-bottom:1px; padding-top:1px">
                                          <i class="glyphicon glyphicon-remove"></i> Cancel
                                        </button>
                                        <div style="padding-top:5px; padding-botton:6px;">
                                          <apex:commandButton style="padding-top:1px;padding-bottom:1px;" StyleClass="btn btn-warning btn-block" value="Legend" action="{!showPopup}" reRender="popup"/>
                                        </div>
                                      </li>
                                  </div>
                              </ul>
                          
                          <!--************************FOOTER ******************************-->
                                <ul class="list-unstyled hidden-xs" id="sidebar-footer">
                                    <li>
                                        <h3>Map Search</h3> 
                                        <i class="glyphicon glyphicon-map-marker"></i> Camoplast Solideal
                                    </li>
                                </ul>
                  
                <!--**************************** TINY ONLY NAV MOBILE  ********************************-->
                                <ul class="nav visible-xs" id="xs-menu">
                                    <li>
                                        <a class="text-center">
                                          <img src="https://cdn1.iconfinder.com/data/icons/metro-uinvert-dock/128/User_Accounts.png" height="20" width="20"></img>
                                        </a>
                                    </li>
                                    <li>
                                        <a class="text-center">
                                          <img src="https://cdn1.iconfinder.com/data/icons/metro-uinvert-dock/128/User_Accounts_alt.png" height="20" width="20"></img>
                                        </a>
                                    </li>
                      
                                    <br/><br/>
                                    <li>
                                        <a href="#" class="text-center">
                                            <i class="glyphicon glyphicon-filter"></i>
                                        </a>
                                    </li>
    
                                    <li>
                                        <a href="#" class="text-center">
                                          <i class="glyphicon glyphicon-floppy-disk"></i>
                                        </a>
                                    </li>
    
                                    <li>
                                        <a href="#" class="text-center">
                                          <i class="glyphicon glyphicon-remove"></i> 
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#" class="text-center">
                                          <i class="glyphicon glyphicon-info-sign"></i>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                <!--*******************************    SIDEBAR END     ********************************-->
    
    
              
                <!--*******************************  MAIN RIGHT COLUMN ********************************-->
                <div class="column col-sm-10 col-xs-11" id="main">
    
                    <!--***************************    TOP NAV START   ********************************-->
                    <div class="navbar navbar-blue navbar-static-top">  
                       <div class="navbar-header" role="navigation">
                            <span class="navbar-brand logo, collapse navbar-collapse">Find Nearby</span>
                       </div>
                        <nav role="navigation"> 
                           <form class="navbar-form navbar-left">
                                <div class="input-group input-group-sm, pushDown" style="max-width:360px;">
                                    <input type="text" class="form-control" placeholder="Search Location..." id="address" name="address"></input>
                                    <div class="input-group-btn">
                                      <a class="btn btn-default" onclick="window.location.href='/apex/TestPage?location='+document.getElementById('address').value+'&Accounts=true&Leads=true'">
                                        <i class="glyphicon glyphicon-search"></i>
                                      </a>
                                      &nbsp;&nbsp;<a class="btn btn-default" onclick="window.location.href='/apex/TestPage'" data-toggle="tooltip" id="left" >
                                         <i class="glyphicon glyphicon-record"></i>
                                      </a>
                                    </div>
                                </div>
                            </form>                            
                            <!--<ul class="nav navbar-nav">
                                <!-- Nav Bar Center -->
                            <!--</ul>
                            <ul class="nav navbar-nav navbar-right">
                                <!-- Nav Bar Right -->
                            <!--</ul>-->
                        </nav>
                       </div>
                    <!--****************************** TOP NAV END   *********************************-->
                    
                    <!-- ***************************** LEGEND POPUP  *********************************-->
                    <div class="responsive-iframe-container">
                      <apex:outputPanel id="popup">
                        <apex:outputPanel styleClass="customPopup" layout="block" rendered="{!legendPopUp}">
                            <div>
                              <b>Legend</b> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <apex:commandButton value="x" StyleClass="btn btn-danger" action="{!closePopup}" rerender="popup"/> <br/>
                              <img src="http://google.com/mapfiles/arrow.png">Location Searched</img>  <br/>
                              <img src="https://maps.google.com/mapfiles/ms/micons/blue-dot.png">Lead</img> <br/> 
                              <img src="https://maps.google.com/mapfiles/ms/micons/yellow-dot.png">Customer - Inactive </img> <br/> 
                              <img src="https://maps.google.com/mapfiles/ms/micons/red-dot.png">Customer - Active</img> <br/> 
                              <img src="https://www.google.com/mapfiles/kml/paddle/wht-circle-lv.png" height="20" width="20">Customer - Active</img> 
                            </div>
                        </apex:outputPanel>
                      </apex:outputPanel>
                    </div>
                    <!-- *****************************     MAP       *********************************--> 
                    <div id="map-canvas"></div>
                </div>
              </div>
            </div>
          </div>
        </apex:form>
       </body>
     </html>
    </apex:page>